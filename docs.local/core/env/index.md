# TypeProf Core Env ドキュメント

## 概要

TypeProfのCore Envモジュールは、型解析のための環境を管理します。このモジュールは、グローバル環境、ローカル環境、コンテキスト参照（CRef）、およびさまざまなエンティティ（メソッド、モジュール、値、型エイリアスなど）を定義し、TypeProfの抽象解釈に基づく型推論の基盤を提供します。

## ディレクトリ構造

`lib/typeprof/core/env/` ディレクトリには以下のファイルが含まれています：

- `method_entity.rb` - メソッドエンティティの定義と管理
- `static_read.rb` - 静的な読み取り処理（定数や型エイリアスなど）
- `module_entity.rb` - モジュール/クラスエンティティの定義と管理
- `type_alias_entity.rb` - 型エイリアスエンティティの定義と管理
- `method.rb` - メソッド引数と呼び出し引数の処理
- `value_entity.rb` - 値エンティティの定義と管理

また、ディレクトリ外にある `lib/typeprof/core/env.rb` ファイルにはこのモジュールの主要なクラスが定義されています。

## 主要なクラスと機能

### 1. GlobalEnv (env.rb)

グローバル環境を管理するクラスです。TypeProfの型解析全体を通じて使用される環境変数やエンティティを保持します。

主な責務：
- クラス、モジュール、定数、メソッドなどのグローバルな定義を管理
- 型テーブルの管理
- 実行キューの管理
- 変更の静的評価キューの管理
- 型インスタンスの生成と管理
- クラスの継承関係の管理

主要なメソッド：
- `initialize` - グローバル環境の初期化
- `resolve_cpath` - クラスパスの解決
- `resolve_const` - 定数の解決
- `resolve_method` - メソッドの解決
- `each_superclass` - スーパークラスの走査
- `define_all` - すべての定義の処理
- `run_all` - すべての実行キューの処理
- `load_core_rbs` - コアRBSの読み込み

### 2. LocalEnv (env.rb)

ローカル環境（レキシカルスコープ）を管理するクラスです。ローカル変数、現在のコンテキスト、戻り値ボックスなどを保持します。

主な責務：
- ローカル変数の管理
- コンテキスト参照（CRef）の保持
- 戻り値ボックスの管理
- break/next処理の管理
- 型フィルターの管理

主要なメソッド：
- `initialize` - ローカル環境の初期化
- `new_var` - 新しい変数の作成
- `get_var` - 変数の取得
- `add_return_box` - 戻り値ボックスの追加
- `apply_read_filter` - 読み取りフィルターの適用

### 3. CRef (env.rb)

コンテキスト参照を表すクラスです。スコープレベル、メソッドID、クラスパスなどを保持し、現在のコンテキストでの`self`の解決に使用されます。

主な責務：
- 現在のクラスパスの保持
- スコープレベル（インスタンス/クラス）の管理
- 現在のメソッドIDの保持
- 外部コンテキストへの参照の管理

主要なメソッド：
- `initialize` - CRefの初期化
- `get_self` - 現在のコンテキストでの`self`の取得

### 4. MethodEntity (method_entity.rb)

メソッドエンティティを表すクラスです。メソッドの宣言（decl）と定義（def）を管理し、メソッド呼び出しを追跡します。

主な責務：
- メソッド宣言の管理
- メソッド定義の管理
- メソッドエイリアスの管理
- メソッド呼び出しボックスの管理

主要なメソッド：
- `add_decl` - メソッド宣言の追加
- `add_def` - メソッド定義の追加
- `add_alias` - メソッドエイリアスの追加
- `exist?` - メソッドが存在するかの確認
- `add_run_all_mdefs` - すべてのメソッド定義の実行追加
- `add_run_all_method_call_boxes` - すべてのメソッド呼び出しボックスの実行追加

### 5. ModuleEntity (module_entity.rb)

モジュールエンティティを表すクラスです。クラスやモジュールの宣言、定義、継承関係、内部モジュール、定数、メソッドなどを管理します。

主な責務：
- モジュール宣言と定義の管理
- 内部モジュールの管理
- 親子関係（継承、インクルード）の管理
- 型パラメータの管理
- 定数、メソッド、インスタンス変数、クラス変数の管理
- 静的読み取りの管理

主要なメソッド：
- `initialize` - モジュールエンティティの初期化
- `add_module_decl` - モジュール宣言の追加
- `add_module_def` - モジュール定義の追加
- `add_include_decl` - includeの宣言の追加
- `add_include_def` - includeの定義の追加
- `on_inner_modules_changed` - 内部モジュール変更時の処理
- `on_parent_modules_changed` - 親モジュール変更時の処理
- `get_const` - 定数の取得
- `get_method` - メソッドの取得
- `get_ivar` - インスタンス変数の取得
- `get_cvar` - クラス変数の取得
- `get_type_alias` - 型エイリアスの取得

### 6. ValueEntity (value_entity.rb)

値エンティティを表すクラスです。値の宣言と定義を管理し、読み取りボックスを追跡します。

主な責務：
- 値の宣言の管理
- 値の定義の管理
- 読み取りボックスの管理
- 値の頂点（vtx）の管理

主要なメソッド：
- `add_decl` - 値の宣言の追加
- `add_def` - 値の定義の追加
- `exist?` - 値が存在するかの確認

### 7. TypeAliasEntity (type_alias_entity.rb)

型エイリアスエンティティを表すクラスです。型エイリアスの宣言を管理します。

主な責務：
- 型エイリアス宣言の管理
- 型の保持

主要なメソッド：
- `add_decl` - 型エイリアス宣言の追加
- `exist?` - 型エイリアスが存在するかの確認

### 8. FormalArguments (method.rb)

メソッド定義の形式引数を表すクラスです。必須引数、オプション引数、可変長引数、キーワード引数などを管理します。

主な責務：
- 位置引数（必須、オプション、可変長、後置）の管理
- キーワード引数（必須、オプション、可変長）の管理
- ブロック引数の管理

### 9. ActualArguments (method.rb)

メソッド呼び出しの実引数を表すクラスです。位置引数、スプラット、キーワード、ブロックを管理します。

主な責務：
- 位置引数の管理
- スプラットフラグの管理
- キーワード引数の管理
- ブロック引数の管理

主要なメソッド：
- `new_vertexes` - 新しい頂点の作成
- `get_rest_args` - 残りの引数の取得
- `get_keyword_arg` - キーワード引数の取得

### 10. StaticRead (static_read.rb)

静的な読み取り処理の基底クラスです。定数や型エイリアスの静的な解決を担当します。

主な責務：
- 静的読み取りの名前管理
- フォロワー（依存するエンティティ）の管理
- ソースモジュールの管理

サブクラス：
- `BaseStaticRead` - 基本的な静的読み取り
- `ScopedStaticRead` - スコープ付き静的読み取り
- `BaseConstRead` - 基本的な定数読み取り
- `ScopedConstRead` - スコープ付き定数読み取り
- `BaseTypeAliasRead` - 基本的な型エイリアス読み取り
- `ScopedTypeAliasRead` - スコープ付き型エイリアス読み取り

## 環境モジュールの役割

TypeProfの環境モジュールは、型解析におけるコンテキストと状態を管理する中心的な役割を果たします。主に以下の機能を提供します：

1. **型コンテキストの管理**：
   - グローバルな型定義の追跡
   - ローカルな型変数の追跡
   - クラスやモジュールの階層関係の管理

2. **静的解析の基盤提供**：
   - 定数の解決
   - メソッドの検索
   - 型エイリアスの管理

3. **実行コンテキストのシミュレーション**：
   - self参照の解決
   - メソッド呼び出しの追跡
   - 引数の受け渡し

4. **型の流れの管理**：
   - 値から型への変換
   - 型の伝播
   - 型フィルターの適用

## TypeProfの抽象解釈との関連

TypeProfは「Rubyプログラムを型レベルで抽象的に実行するインタプリタ」です。環境モジュールは、この抽象実行のためのコンテキストを提供します。

1. **抽象値の管理**：
   - 環境モジュールは、具体的な値ではなく型（クラス）レベルに抽象化された値を扱います
   - `GlobalEnv`クラスでは、基本的な型（Integer、String、Nil等）のインスタンスを管理します

2. **型の伝播**：
   - メソッド呼び出しやオブジェクト間の型情報の伝播を追跡します
   - `run_all`メソッドでは、型情報の伝播を実行します

3. **コンテキスト対応の型推論**：
   - `CRef`と`LocalEnv`を通じて、現在のコンテキストに応じた型推論を行います
   - クラス階層やモジュールのインクルード関係に基づいた型の解決を行います

4. **静的解析と動的実行のハイブリッド**：
   - 静的な定義フェーズ（`define_all`）と動的な実行フェーズ（`run_all`）を組み合わせて型情報を計算します
   - これにより、静的解析だけでは捉えられない動的な型の流れを追跡できます

## まとめ

TypeProfのCore Envモジュールは、抽象解釈に基づく型解析のための環境を提供します。グローバル環境、ローカル環境、コンテキスト参照などの主要コンポーネントと、様々なエンティティ（メソッド、モジュール、値、型エイリアスなど）を管理し、型情報の流れを追跡します。これらのコンポーネントが連携することで、Rubyコードの型レベルでの抽象実行と型推論が可能になります。
