# TypeProf Core Graph ドキュメント

## 概要

TypeProfのCore Graphモジュールは、型解析のための型グラフを管理します。このモジュールは、型の流れを表す頂点（Vertex）とエッジ、およびそれらの操作を行うボックス（Box）、変更を管理する変更セット（ChangeSet）、型のフィルタリングを行うフィルター（Filter）などを定義し、TypeProfの抽象解釈に基づく型推論の中核となる機能を提供します。

## ディレクトリ構造

`lib/typeprof/core/graph/` ディレクトリには以下のファイルが含まれています：

- `box.rb` - 型グラフの操作を表現するボックスクラスの定義
- `change_set.rb` - 型グラフへの変更を管理する変更セットクラスの定義
- `vertex.rb` - 型グラフのノードを表現する頂点クラスの定義
- `filter.rb` - 型のフィルタリングを行うフィルタークラスの定義

## 主要なクラスと機能

### 1. Box (box.rb)

型グラフの操作を表現する基底クラスです。各種の操作（メソッド呼び出し、定数読み取りなど）に対応したサブクラスが存在します。

主な責務：
- 型グラフへの変更を管理する（変更セットを通じて）
- 操作によって生じる型の流れを制御する
- 診断情報を収集する

主要なメソッド：
- `initialize` - ボックスの初期化
- `destroy` - ボックスの破棄
- `run` - ボックスの実行
- `on_type_added` - 型が追加されたときの処理
- `on_type_removed` - 型が削除されたときの処理
- `diagnostics` - 診断情報の収集

主要なサブクラス：
- `ConstReadBox` - 定数の読み取り操作
- `TypeReadBox` - 型の読み取り操作
- `MethodDeclBox` - メソッド宣言操作
- `MethodCallBox` - メソッド呼び出し操作
- `EscapeBox` - 値の戻り操作
- `SplatBox` - スプラット操作
- `HashSplatBox` - ハッシュスプラット操作
- `MAsgnBox` - 多重代入操作
- `MethodDefBox` - メソッド定義操作
- `MethodAliasBox` - メソッドエイリアス操作
- `GVarReadBox` - グローバル変数の読み取り操作
- `IVarReadBox` - インスタンス変数の読み取り操作
- `CVarReadBox` - クラス変数の読み取り操作
- `InstanceTypeBox` - インスタンス型操作

### 2. ChangeSet (change_set.rb)

型グラフへの変更を管理するクラスです。エッジの追加・削除、ボックスの追加・削除、診断情報の管理などを行います。

主な責務：
- 型グラフのエッジの管理
- ボックス操作の管理
- 診断情報の管理
- 依存関係の管理（値エンティティ、メソッドエンティティ、静的読み取り、スーパークラスなど）

主要なメソッド：
- `initialize` - 変更セットの初期化
- `reuse` - 変更セットの再利用
- `add_edge` - エッジの追加
- `add_*_box` - 各種ボックスの追加（例：`add_method_call_box`, `add_const_read_box`など）
- `add_diagnostic` - 診断情報の追加
- `add_depended_*` - 依存関係の追加
- `reinstall` - 変更の再インストール

### 3. Vertex (vertex.rb)

型グラフのノードを表現するクラスです。型の集合と、それらの間の関係を管理します。

主な責務：
- 型の集合の管理
- 型の追加・削除
- 型の伝播
- 型の表示

主要なクラス：
- `BasicVertex` - 頂点の基底クラス
- `Source` - 型の源泉となる特殊な頂点
- `Vertex` - 一般的な頂点

主要なメソッド：
- `initialize` - 頂点の初期化
- `each_type` - 各型に対する繰り返し処理
- `on_type_added` - 型が追加されたときの処理
- `on_type_removed` - 型が削除されたときの処理
- `add_edge` - エッジの追加
- `remove_edge` - エッジの削除
- `new_vertex` - 新しい頂点の作成
- `check_match` - 型のマッチング確認
- `show` - 型の表示

### 4. Filter (filter.rb)

型のフィルタリングを行うクラスです。条件に基づいて型を絞り込む機能を提供します。

主な責務：
- 条件に基づく型のフィルタリング
- フィルタリングされた型の伝播

主要なサブクラス：
- `NilFilter` - nilかどうかでフィルタリング
- `IsAFilter` - is_a?関係でフィルタリング
- `BotFilter` - 到達不能コード（bottom型）のフィルタリング

主要なメソッド：
- `initialize` - フィルターの初期化
- `filter` - 型のフィルタリング
- `on_type_added` - 型が追加されたときの処理
- `on_type_removed` - 型が削除されたときの処理

## 型グラフの仕組み

TypeProfの型グラフは、プログラム内の型の流れを表現するためのデータ構造です。

1. **頂点（Vertex）**：
   - 型の集合を保持する
   - 各頂点は、変数、メソッドの引数、戻り値などに対応する

2. **エッジ**：
   - 頂点間の型の流れを表す
   - あるメソッド呼び出しの引数から戻り値への型の流れなどを表現する

3. **ボックス（Box）**：
   - プログラム内の操作を表現する
   - 操作によって生じる型の流れを制御する
   - 変更セット（ChangeSet）を通じて型グラフを更新する

4. **変更セット（ChangeSet）**：
   - 型グラフへの変更をまとめて管理する
   - 変更の一括適用、ロールバックを可能にする

5. **フィルター（Filter）**：
   - 条件分岐などによる型の絞り込みを表現する
   - `if x.nil?`のようなコードによる型情報の精緻化を実現する

## 型の伝播

型グラフにおける型の伝播は、以下のようなステップで行われます：

1. **型の追加**：
   - 頂点に型が追加されると、`on_type_added`が呼び出される
   - 追加された型は、エッジを通じて接続された次の頂点に伝播する

2. **型の削除**：
   - 頂点から型が削除されると、`on_type_removed`が呼び出される
   - 削除された型は、エッジを通じて接続された次の頂点からも削除される

3. **ボックスの実行**：
   - 型が変更されると、関連するボックスの`run`メソッドが呼び出される
   - ボックスは必要に応じて新たな型の追加や削除を行う

4. **変更の適用**：
   - 変更セットの`reinstall`メソッドにより、変更が型グラフに適用される

## 特徴的な機能

### 1. 多様なボックス型

様々な操作に対応した多様なボックス型を提供しています：
- メソッド呼び出し、定義、宣言、エイリアス
- 定数、変数（インスタンス変数、クラス変数、グローバル変数）の読み取り
- 型の読み取り
- 値のエスケープ（メソッドからの戻りなど）
- スプラット、ハッシュスプラット、多重代入など

### 2. 変更管理の仕組み

変更セット（ChangeSet）を通じた効率的な変更管理により、以下のことが可能になっています：
- 変更のまとめて適用
- 変更のロールバック
- 変更の差分計算

### 3. 型フィルタリング

条件分岐に基づく型の絞り込みを実現するフィルタリング機能：
- `NilFilter` - nilかどうかによる絞り込み
- `IsAFilter` - クラスの種類による絞り込み
- `BotFilter` - 到達不能コードの検出

## TypeProfの抽象解釈との関連

TypeProfは「Rubyプログラムを型レベルで抽象的に実行するインタプリタ」です。Core Graphモジュールは、この抽象実行の中核となる部分を担っています。

1. **抽象値の伝播**：
   - Rubyの具体的な値ではなく、抽象化された型の流れを追跡します
   - 型グラフを通じて型情報が伝播することで、メソッドの引数型や戻り値型が推論されます

2. **型制約の解決**：
   - メソッド呼び出しや条件分岐によって生じる型の制約を解決します
   - フィルターによる型の絞り込みや、メソッド呼び出しによる型の変換などを処理します

3. **再帰的な型推論**：
   - 相互に依存するメソッド間の型情報を再帰的に解決します
   - 変更が生じると関連するボックスが再実行され、型情報が更新されます

## まとめ

TypeProfのCore Graphモジュールは、型の流れを表現するためのグラフ構造を提供し、抽象解釈に基づく型推論の中核となる機能を担っています。型の頂点（Vertex）、それらを操作するボックス（Box）、変更を管理する変更セット（ChangeSet）、型のフィルタリングを行うフィルター（Filter）などの主要コンポーネントが連携することで、複雑なRubyプログラムの型推論が可能になっています。
